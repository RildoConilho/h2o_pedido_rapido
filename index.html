<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>H2O Pedido R√°pido</title>

    <meta name="description" content="Pe√ßa sua √°gua da Distribuidora H2O de forma r√°pida e f√°cil com o app H2O Pedido R√°pido. Adicione √† sua tela inicial!">

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" href="icones/apple-icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="H2O √Ågua">

    <meta property="og:title" content="Distribuidora H2O: Pe√ßa sua √°gua pelo app!">
    <meta property="og:description" content="A forma mais pr√°tica de pedir √°gua da Distribuidora H2O! Baixe nosso app direto na sua tela inicial e fa√ßa seu pedido com poucos cliques.">
    <meta property="og:image" content="URL_DA_SUA_IMAGEM_DE_COMPARTILHAMENTO_AQUI">
    <meta property="og:url" content="https://h2opediraguafacil.netlify.app/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="H2O Pedido R√°pido">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Distribuidora H2O: Pe√ßa sua √°gua pelo app!">
    <meta name="twitter:description" content="A forma mais pr√°tica de pedir √°gua da Distribuidora H2O! Baixe nosso app direto na sua tela inicial e fa√ßa seu pedido com poucos cliques.">
    <meta name="twitter:image" content="URL_DA_SUA_IMAGEM_DE_COMPARTILHAMENTO_AQUI">
    <meta name="theme-color" content="#00BFFF">
    <style>
        :root {
            --cor-primaria: #00BFFF;
            --cor-texto: #212529;
            --cor-texto-claro: #FFFFFF;
            --cor-fundo: #F8F9FA;
            --cor-fundo-cartao: #FFFFFF;
            --sombra-cartao: 0 4px 12px rgba(0, 0, 0, 0.1);
            --cor-texto-secundario: #6C757D;
            --cor-botao-hover: #0099CC;
            --cor-botao-instalar: #28a745;
            --cor-botao-instalar-hover: #218838;
            --cor-botao-notificacao: #ffc107;
            --cor-botao-notificacao-hover: #e0a800;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 100vh; box-sizing: border-box; }
        .container-principal { background-color: var(--cor-fundo-cartao); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-cartao); max-width: 400px; width: 100%; margin-top: 20px; margin-bottom: 20px; }
        .logo-h2o-img { max-width: 100px; height: auto; margin-bottom: 15px; }
        #saudacaoCliente { font-size: 1.6em; margin-bottom: 10px; color: var(--cor-primaria); font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.15); }
        h1 { font-size: 1.8em; color: var(--cor-texto); margin-top: 0; margin-bottom: 10px; }
        .slogan { font-size: 1em; color: var(--cor-texto-secundario); margin-bottom: 25px; }
        .btn { display: block; width: 100%; padding: 12px; font-size: 1em; font-weight: bold; text-decoration: none; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; margin-bottom: 15px; box-sizing: border-box; }
        .btn-pedir-agua { padding: 15px; font-size: 1.2em; background-color: var(--cor-primaria); color: var(--cor-texto-claro); }
        .btn-pedir-agua:hover, .btn-pedir-agua:focus { background-color: var(--cor-botao-hover); }
        .btn-instalar-pwa { background-color: var(--cor-botao-instalar); color: var(--cor-texto-claro); }
        .btn-instalar-pwa:hover, .btn-instalar-pwa:focus { background-color: var(--cor-botao-instalar-hover); }
        /* Alterar cor do bot√£o de notifica√ß√£o para ser diferente da cor de ativa√ß√£o de lembretes FCM */
        .btn-agendar-lembrete { background-color: #6C757D; color: var(--cor-texto-claro); } /* Cinza */
        .btn-agendar-lembrete:hover, .btn-agendar-lembrete:focus { background-color: #5a6268; }
        .btn-agendar-lembrete.ativado { background-color: #28a745; } /* Verde - Indica que est√° ativo */
        .btn-agendar-lembrete.ativado:hover { background-color: #218838; }

        .btn-ativar-notificacao { background-color: var(--cor-botao-notificacao); color: var(--cor-texto); }
        .btn-ativar-notificacao:hover, .btn-ativar-notificacao:focus { background-color: var(--cor-botao-notificacao-hover); }
        .btn-ativar-notificacao.desativado { background-color: #6c757d; color: var(--cor-texto-claro); cursor: not-allowed; }

        .dica-add-tela { font-size: 0.9em; color: var(--cor-texto-secundario); background-color: #e9ecef; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .dica-add-tela p { margin: 5px 0; }
        .info-contato { font-size: 0.9em; color: var(--cor-texto-secundario); }
        .info-contato p { margin: 5px 0; }
        .info-contato a { color: var(--cor-primaria); text-decoration: none; }
        .info-contato a:hover { text-decoration: underline; }
        #dicaInstalarIOS { background-color: #e6f7ff; padding: 15px; border-radius: 8px; margin-top: 15px; margin-bottom: 15px; border: 1px solid #90c5e2; text-align: left; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #dicaInstalarIOS p { margin: 0; font-size: 0.95em; color: #333; line-height: 1.5; }
        #dicaInstalarIOS a { color: var(--cor-primaria); font-weight: bold; text-decoration: underline; }
        #dicaInstalarIOS a:hover { text-decoration: none; }
        #fecharDicaIOS { float: right; background: none; border: none; font-size: 1.5em; font-weight: bold; cursor: pointer; color: #888; padding: 0 0 0 10px; line-height: 1; }
        #fecharDicaIOS:hover { color: #333; }
        #instrucoes-ios-detalhadas { display: none; margin-top: 20px; padding: 20px; background-color: var(--cor-fundo-cartao); border-radius: 8px; box-shadow: var(--sombra-cartao); text-align: left; }
        #instrucoes-ios-detalhadas h2 { margin-top: 0; color: var(--cor-primaria); font-size: 1.4em; margin-bottom: 15px; }
        #instrucoes-ios-detalhadas ol { padding-left: 20px; }
        #instrucoes-ios-detalhadas li { margin-bottom: 10px; line-height: 1.5; }
        #instrucoes-ios-detalhadas strong { font-weight: bold; }
        #instrucoes-ios-detalhadas .dica-interna { font-size: 0.9em; color: var(--cor-texto-secundario); margin-top:5px; }
        #instrucoes-ios-detalhadas .resultado-final-titulo { font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: var(--cor-texto); }
        #instrucoes-ios-detalhadas .resultado-final-item { margin-bottom: 8px; padding-left: 20px; position: relative; }
        #instrucoes-ios-detalhadas .resultado-final-item::before { content: '‚úîÔ∏è'; position: absolute; left: 0; color: var(--cor-botao-instalar); }
        #statusNotificacao { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; font-size: 0.9em; }
        #statusNotificacao.sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #statusNotificacao.erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Estilos para o popup de agendamento de lembretes */
        #modalAgendarLembrete {
            display: none; /* Escondido por padr√£o */
            position: fixed; /* Fixo na tela */
            z-index: 1000; /* Acima de tudo */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita rolagem se necess√°rio */
            background-color: rgba(0,0,0,0.7); /* Fundo escuro transparente */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: left;
            position: relative; /* Para o bot√£o de fechar */
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--cor-primaria);
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--cor-texto);
        }

        .modal-content select, .modal-content input[type="number"] {
            width: calc(100% - 20px); /* Ajuste para padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        .modal-content input[type="number"] {
            width: 80px; /* Largura menor para o n√∫mero de dias */
            display: inline-block;
            margin-right: 10px;
        }

        .modal-content .botoes-modal {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .modal-content .btn-modal {
            flex-grow: 1;
            margin: 0 5px;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            border: none;
            transition: background-color 0.2s ease;
        }

        .modal-content .btn-modal.cancelar {
            background-color: #dc3545;
            color: white;
        }
        .modal-content .btn-modal.cancelar:hover {
            background-color: #c82333;
        }

        .modal-content .btn-modal.confirmar {
            background-color: var(--cor-primaria);
            color: var(--cor-texto-claro);
        }
        .modal-content .btn-modal.confirmar:hover {
            background-color: var(--cor-botao-hover);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        #lembreteAgendadoStatus {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--cor-texto-secundario);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-principal">
        <img src="https://st4.depositphotos.com/20523700/25934/i/380/depositphotos_259345310-stock-photo-illustration-h2o-icon.jpg" alt="Logo Distribuidora H2O" class="logo-h2o-img">
        <p id="saudacaoCliente"></p>
        <div id="dicaInstalarIOS" style="display: none;">
            <button id="fecharDicaIOS" title="Fechar dica">&times;</button>
            <p>
                <strong>Dica para iPhone/iPad:</strong> Sabia que pode adicionar o H2O Pedido R√°pido √† sua Tela de In√≠cio para acesso super f√°cil?
                <a href="#instrucoes-ios-detalhadas" id="linkInstrucoesIOS">Clique aqui para ver como!</a>
            </p>
        </div>
        <h1>Distribuidora de √Ågua H2O</h1>
        <p class="slogan">Pe√ßa sua √°gua de forma r√°pida e f√°cil!</p>
        <a href="https://wa.me/5517996512353?text=Ol%C3%A1!%20Gostaria%20de%20pedir%20%C3%A1gua.%20Quantidade%3A%20" class="btn btn-pedir-agua" target="_blank">
            üíß Pedir √Ågua Agora
        </a>
        <button id="btnInstalarApp" class="btn btn-instalar-pwa" style="display: none;">
            ‚≠ê Instalar Aplicativo
        </button>
        <button id="btnAtivarNotificacoes" class="btn btn-ativar-notificacao">
            üîî Ativar Lembretes (FCM)
        </button>
        <button id="btnAgendarLembreteLocal" class="btn btn-agendar-lembrete">
            ‚è∞ Agendar Lembrete de √Ågua
        </button>
        <div id="lembreteAgendadoStatus"></div>

        <div id="statusNotificacao"></div>
        <div id="instrucoes-ios-detalhadas">
            <h2>‚ú® Como Adicionar o "H2O Pedido R√°pido" √† Tela de In√≠cio do seu iPhone ou iPad ‚ú®</h2>
            <p>Quer ter nosso aplicativo "H2O Pedido R√°pido" sempre √† m√£o, como um app que voc√™ instalou da loja? √â super f√°cil! Siga estes passinhos simples:</p>
            <ol>
                <li>üåê <strong>Abra o Safari:</strong> No seu iPhone ou iPad, toque no √≠cone azul do navegador <strong>Safari</strong> para abri-lo.</li>
                <li>‚û°Ô∏è <strong>Acesse o Nosso Site:</strong> Na barra de endere√ßos, escreva: <strong style="color: var(--cor-primaria);">https://h2opediraguafacil.netlify.app/</strong> e toque em "Ir".</li>
                <li>üì§ <strong>Toque no √çcone de Compartilhamento:</strong> Na barra de ferramentas do Safari, toque no √≠cone de <strong>Compartilhamento</strong> (quadradinho com seta para cima).</li>
                <li>‚ûï <strong>Encontre "Adicionar √† Tela de In√≠cio":</strong> Role o menu e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong>.</li>
                <li>‚úÖ <strong>Confirme e Adicione:</strong> Edite o nome se quiser e toque em <strong>"Adicionar"</strong>.</li>
            </ol>
            <p class="resultado-final-titulo">üéâ Prontinho! üéâ</p>
            <ul>
                <li class="resultado-final-item">Um √≠cone do "H2O Pedido R√°pido" aparecer√° na sua Tela de In√≠cio!</li>
                <li class="resultado-final-item">Toque nele para acesso r√°pido ao app.</li>
            </ul>
            <button id="fecharInstrucoesIOSDetalhadas" class="btn btn-instalar-pwa" style="background-color: var(--cor-texto-secundario); margin-top:15px;">Fechar Instru√ß√µes</button>
        </div>
        <div class="dica-add-tela">
            <p><strong>DICA R√ÅPIDA (Geral):</strong></p>
            <p>Adicione esta p√°gina √† sua tela inicial para pedir √°gua com apenas um toque no futuro!</p>
            <p><small>(No seu navegador, procure a op√ß√£o "Adicionar √† tela inicial" ou "Instalar aplicativo" no menu).</small></p>
        </div>
        <div class="info-contato">
            <p><strong>Contato H2O:</strong></p>
            <p>Telefone: <a href="tel:+5517996512353">(17) 99651-2353</a></p>
        </div>
    </div>

    <div id="modalAgendarLembrete" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2>Agendar Lembrete de √Ågua</h2>
            <label for="tempoLembrete">Lembrar em:</label>
            <select id="tempoLembrete">
                <option value="7">7 dias</option>
                <option value="10">10 dias</option>
                <option value="15">15 dias</option>
                <option value="30">30 dias</option>
                <option value="custom">Outro tempo (dias)</option>
            </select>
            <div id="customTimeInput" style="display: none; margin-top: 10px;">
                <label for="diasCustom">N√∫mero de dias:</label>
                <input type="number" id="diasCustom" min="1" value="1">
            </div>
            <div class="botoes-modal">
                <button class="btn-modal cancelar" id="btnCancelarLembreteLocal">Cancelar Lembrete</button>
                <button class="btn-modal confirmar" id="btnConfirmarAgendamento">Agendar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Imports do Firebase SDK (usando a vers√£o 11.8.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-messaging.js";

        // Objeto de configura√ß√£o do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCicQdcV7crJVSbVUX_OK5yNEO0ZjIg11Y",
          authDomain: "h2o-pedido-rapido-pwa.firebaseapp.com",
          projectId: "h2o-pedido-rapido-pwa",
          storageBucket: "h2o-pedido-rapido-pwa.firebasestorage.app",
          messagingSenderId: "878082690218",
          appId: "1:878082690218:web:e49ecc3154d570b5c714d3"
        };

        // *** A SUA CHAVE VAPID P√öBLICA REAL ***
        // (Da sec√ß√£o "Web Push certificates" do Firebase Console)
        // √â essencial que esta chave corresponda √† do seu projeto Firebase.
        const SUA_CHAVE_VAPID_PUBLICA = 'BPQ0g5ZOieblltRRP409nwYsFNvptMyB15T4_cS7E8GhKFVhjIPeGyZ56Xo0zm09zux5ZVt_7mPWRFtynJfRgQk';

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        let serviceWorkerRegistration; // Vari√°vel global para armazenar o registro do SW

        // REGISTRO DO SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker: Registrado com sucesso! Escopo:', registration.scope);
                        serviceWorkerRegistration = registration; // Guarda o registro
                        initialiseNotificationUI(registration);
                        checkScheduledReminderStatus(); // Verifica se j√° h√° um lembrete agendado localmente
                    })
                    .catch(error => {
                        console.error('ServiceWorker: Falha no registro:', error);
                        if (btnAtivarNotificacoes) {
                            btnAtivarNotificacoes.textContent = 'Erro no Service Worker';
                            btnAtivarNotificacoes.disabled = true;
                            btnAtivarNotificacoes.classList.add('desativado');
                        }
                        // Tamb√©m desabilita o bot√£o de agendamento local se o SW falhar
                        if (btnAgendarLembreteLocal) {
                            btnAgendarLembreteLocal.textContent = 'Lembretes Locais Indispon√≠veis';
                            btnAgendarLembreteLocal.disabled = true;
                            btnAgendarLembreteLocal.classList.add('desativado');
                        }
                        mostrarStatus('Erro ao registrar o Service Worker. Notifica√ß√µes podem n√£o funcionar.', 'erro');
                    });
            });
        }

        // FUN√á√ïES DE UI E L√ìGICA PWA EXISTENTE
        function exibirSaudacaoDinamica() {
            const elementoSaudacao = document.getElementById('saudacaoCliente');
            if (elementoSaudacao) {
                const agora = new Date();
                const horaAtual = agora.getHours();
                let textoSaudacao = '';
                if (horaAtual >= 5 && horaAtual < 12) { textoSaudacao = 'Bom dia!'; }
                else if (horaAtual >= 12 && horaAtual < 18) { textoSaudacao = 'Boa tarde!'; }
                else { textoSaudacao = 'Boa noite!'; }
                elementoSaudacao.textContent = textoSaudacao;
            }
        }

        let deferredPrompt;
        const btnInstalarApp = document.getElementById('btnInstalarApp');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (btnInstalarApp) { btnInstalarApp.style.display = 'block'; }
        });
        if (btnInstalarApp) {
            btnInstalarApp.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('Resultado do prompt de instala√ß√£o PWA:', outcome);
                    deferredPrompt = null;
                    btnInstalarApp.style.display = 'none';
                }
            });
        }
        window.addEventListener('appinstalled', () => {
            console.log('PWA instalado!');
            if (btnInstalarApp) btnInstalarApp.style.display = 'none';
            deferredPrompt = null;
        });

        const dicaIOSContainer = document.getElementById('dicaInstalarIOS');
        const linkInstrucoesIOS = document.getElementById('linkInstrucoesIOS');
        const btnFecharDicaIOS = document.getElementById('fecharDicaIOS');
        const secaoInstrucoesDetalhadas = document.getElementById('instrucoes-ios-detalhadas');
        const btnFecharInstrucoesDetalhadas = document.getElementById('fecharInstrucoesIOSDetalhadas');
        function mostrarDicaParaIOS() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;
            const dicaJaDispensada = localStorage.getItem('dicaIOSDispensadaPermanente');
            if (isIOS && !isInStandaloneMode && !dicaJaDispensada && dicaIOSContainer) {
                const pwaInstallButtonVisible = btnInstalarApp && getComputedStyle(btnInstalarApp).display !== 'none';
                if(!pwaInstallButtonVisible) { dicaIOSContainer.style.display = 'block'; }
            }
        }
        if (dicaIOSContainer && btnFecharDicaIOS) {
            btnFecharDicaIOS.addEventListener('click', () => {
                dicaIOSContainer.style.display = 'none';
                localStorage.setItem('dicaIOSDispensadaPermanente', 'true');
            });
        }
        if (linkInstrucoesIOS && secaoInstrucoesDetalhadas && btnFecharInstrucoesDetalhadas) {
            linkInstrucoesIOS.addEventListener('click', (e) => {
                e.preventDefault();
                secaoInstrucoesDetalhadas.style.display = 'block';
                secaoInstrucoesDetalhadas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if(dicaIOSContainer) dicaIOSContainer.style.display = 'none';
            });
            btnFecharInstrucoesDetalhadas.addEventListener('click', () => {
                secaoInstrucoesDetalhadas.style.display = 'none';
            });
        }

        // --- L√ìGICA PARA NOTIFICA√á√ïES PUSH (FCM) ---
        const btnAtivarNotificacoes = document.getElementById('btnAtivarNotificacoes');
        const statusNotificacaoDiv = document.getElementById('statusNotificacao');

        function mostrarStatus(mensagem, tipo = 'info') {
            if (statusNotificacaoDiv) {
                statusNotificacaoDiv.textContent = mensagem;
                statusNotificacaoDiv.className = tipo;
                statusNotificacaoDiv.style.display = 'block';
            }
        }

        async function sendTokenToBackend(fcmToken) {
            try {
                mostrarStatus('A ativar lembretes...', 'info');
                // IMPORTANTE: Esta fun√ß√£o ainda envia o token para o seu backend Netlify.
                // Se o seu backend estiver com problemas, esta parte ainda pode falhar.
                const response = await fetch('/.netlify/functions/save-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ token: fcmToken }),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Falha ao comunicar com o servidor.' }));
                    throw new Error(errorData.message || `Erro do servidor: ${response.status}`);
                }
                const data = await response.json();
                console.log('Token enviado com sucesso para o backend:', data);
                mostrarStatus('Lembretes ativados com sucesso!', 'sucesso');
                btnAtivarNotificacoes.textContent = 'Lembretes Ativados (FCM)';
                btnAtivarNotificacoes.disabled = true;
                btnAtivarNotificacoes.classList.add('desativado');
            } catch (error) {
                console.error('Erro ao enviar token para o backend:', error);
                mostrarStatus(`Erro ao ativar lembretes FCM: ${error.message}`, 'erro');
                if(btnAtivarNotificacoes) {
                     btnAtivarNotificacoes.disabled = false;
                     btnAtivarNotificacoes.classList.remove('desativado');
                     btnAtivarNotificacoes.textContent = 'üîî Tentar Ativar Lembretes (FCM)';
                }
            }
        }

        function initialiseNotificationUI(swRegistration) {
            if (!('Notification' in window) || !('PushManager' in window) || !swRegistration) {
                console.warn('Recursos de Notifica√ß√µes Push n√£o s√£o suportados ou SW n√£o est√° pronto/registrado.');
                if (btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.textContent = 'Notifica√ß√µes Indispon√≠veis';
                    btnAtivarNotificacoes.disabled = true;
                    btnAtivarNotificacoes.classList.add('desativado');
                }
                return;
            }

            if (Notification.permission === 'granted') {
                console.log('Permiss√£o para notifica√ß√µes j√° concedida ao carregar.');
                getTokenAndSendToBackend(swRegistration);
                if (btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.textContent = 'Lembretes Ativados (FCM)';
                    btnAtivarNotificacoes.disabled = true;
                    btnAtivarNotificacoes.classList.add('desativado');
                }
            } else if (Notification.permission === 'denied') {
                console.warn('Permiss√£o para notifica√ß√µes negada permanentemente.');
                mostrarStatus('Permiss√£o negada. Altere nas configura√ß√µes do navegador.', 'erro');
                if (btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.textContent = 'Permiss√£o Negada';
                    btnAtivarNotificacoes.disabled = true;
                    btnAtivarNotificacoes.classList.add('desativado');
                }
            } else {
                console.log('Permiss√£o para notifica√ß√µes est√° no estado padr√£o (default).');
                if (btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.disabled = false;
                    btnAtivarNotificacoes.classList.remove('desativado');
                    btnAtivarNotificacoes.textContent = 'üîî Ativar Lembretes (FCM)';
                    const clickHandler = () => handleNotificationButtonClick(swRegistration);
                    // Garante que o event listener seja adicionado apenas uma vez
                    btnAtivarNotificacoes.removeEventListener('click', btnAtivarNotificacoes._clickHandler);
                    btnAtivarNotificacoes.addEventListener('click', clickHandler);
                    btnAtivarNotificacoes._clickHandler = clickHandler;
                }
            }
        }

        function handleNotificationButtonClick(swRegistration) {
            console.log("Bot√£o 'Ativar Lembretes (FCM)' clicado.");
            btnAtivarNotificacoes.disabled = true;
            btnAtivarNotificacoes.textContent = 'A processar...';
            subscribeUserToPushFirebase(swRegistration);
        }

        async function subscribeUserToPushFirebase(swRegistration) {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Permiss√£o concedida pelo utilizador ap√≥s clique.');
                    await getTokenAndSendToBackend(swRegistration);
                } else {
                    console.warn('Permiss√£o para notifica√ß√µes negada pelo utilizador ap√≥s clique.');
                    mostrarStatus('Permiss√£o para notifica√ß√µes foi negada.', 'erro');
                    if(btnAtivarNotificacoes) {
                        btnAtivarNotificacoes.textContent = 'Permiss√£o Negada';
                        btnAtivarNotificacoes.disabled = true;
                        btnAtivarNotificacoes.classList.add('desativado');
                    }
                }
            } catch (error) {
                console.error('Erro ao solicitar permiss√£o de notifica√ß√£o:', error);
                mostrarStatus('Erro ao solicitar permiss√£o. Verifique o console.', 'erro');
                if(btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.disabled = false;
                    btnAtivarNotificacoes.classList.remove('desativado');
                    btnAtivarNotificacoes.textContent = 'üîî Tentar Ativar Lembretes (FCM)';
                }
            }
        }

        async function getTokenAndSendToBackend(swRegistration) {
            if (!messaging) {
                console.error("Firebase Messaging n√£o inicializado.");
                mostrarStatus('Erro interno: Messaging n√£o pronto.', 'erro');
                if(btnAtivarNotificacoes) { btnAtivarNotificacoes.disabled = false; btnAtivarNotificacoes.classList.remove('desativado'); btnAtivarNotificacoes.textContent = 'üîî Tentar Ativar Lembretes (FCM)';}
                return;
            }
            if (!swRegistration || !swRegistration.active) {
                console.error("Service Worker Registration n√£o est√° dispon√≠vel ou n√£o est√° ativo para getToken.");
                mostrarStatus('Erro: Service Worker n√£o pronto ou n√£o ativo. Tente recarregar.', 'erro');
                if(btnAtivarNotificacoes) {
                    btnAtivarNotificacoes.disabled = false;
                    btnAtivarNotificacoes.classList.remove('desativado');
                    btnAtivarNotificacoes.textContent = 'üîî Tentar Ativar Lembretes (FCM)';
                }
                return;
            }
            try {
                console.log("Tentando obter token FCM com vapidKey expl√≠cita.");
                const currentToken = await getToken(messaging, {
                    vapidKey: SUA_CHAVE_VAPID_PUBLICA,
                    serviceWorkerRegistration: swRegistration
                });

                if (currentToken) {
                    console.log('Token FCM obtido com sucesso:', currentToken);
                    await sendTokenToBackend(currentToken);
                } else {
                    console.warn('Nenhum token de registro dispon√≠vel. A permiss√£o foi concedida? O SW est√° ativo e pronto?');
                    mostrarStatus('Falha ao obter token. Verifique as permiss√µes, o console e se o Service Worker est√° ativo.', 'erro');
                     if(btnAtivarNotificacoes) {
                        if (Notification.permission !== 'granted') {
                            btnAtivarNotificacoes.disabled = false;
                            btnAtivarNotificacoes.classList.remove('desativado');
                            btnAtivarNotificacoes.textContent = 'üîî Ativar Lembretes (FCM)';
                        } else {
                            btnAtivarNotificacoes.textContent = 'Falha ao obter Token';
                            btnAtivarNotificacoes.disabled = true;
                            btnAtivarNotificacoes.classList.add('desativado');
                        }
                    }
                }
            } catch (error) {
                console.error('Erro espec√≠fico ao obter token FCM:', error, error.code, error.message);
                let userMessage = 'Erro ao obter token. Verifique o console.';
                if (error.code === 'messaging/notifications-blocked' ||
                    error.code === 'messaging/permission-denied') {
                     userMessage = 'Notifica√ß√µes bloqueadas. Verifique as configura√ß√µes do navegador.';
                } else if (error.code === 'messaging/failed-serviceworker-registration' ||
                           error.message.includes('Service Worker') ||
                           error.code === 'messaging/sw-not-supported' ) {
                    userMessage = 'Falha no Service Worker. Verifique se ele est√° ativo e suportado.';
                } else if (error.code === 'messaging/sw-reg-expired') {
                    userMessage = 'Registro do Service Worker expirou. Tente recarregar a p√°gina.';
                } else if (error.code === 'messaging/permission-default') {
                    userMessage = 'A permiss√£o para notifica√ß√µes ainda n√£o foi concedida.';
                } else if (error.message.includes('applicationServerKey is not valid') ||
                           error.code === 'messaging/invalid-vapid-key') {
                    userMessage = 'Chave VAPID fornecida n√£o √© v√°lida. Verifique a configura√ß√£o.';
                } else if (error.code === 'messaging/token-subscribe-failed' || error.response?.status === 401) {
                    userMessage = 'Falha na autentica√ß√£o para obter o token. Verifique as configura√ß√µes da Chave de API no Google Cloud Console.';
                }

                mostrarStatus(userMessage, 'erro');

                if(btnAtivarNotificacoes) {
                     btnAtivarNotificacoes.disabled = false;
                     btnAtivarNotificacoes.classList.remove('desativado');
                     btnAtivarNotificacoes.textContent = 'üîî Tentar Ativar Lembretes (FCM)';
                }
            }
        }

        onMessage(messaging, (payload) => {
            console.log('Mensagem em primeiro plano (FCM) recebida:', payload);
            if (payload.notification) {
                const notificationTitle = payload.notification.title || "H2O Pedido R√°pido";
                const notificationOptions = {
                    body: payload.notification.body || "Nova mensagem",
                    icon: payload.notification.icon || '/icones/android-launchericon-192-192.png',
                };
                const notification = new Notification(notificationTitle, notificationOptions);
                notification.onclick = (event) => {
                    event.preventDefault();
                    window.focus();
                };
            } else {
                console.log("Payload em primeiro plano sem campo 'notification':", payload.data);
            }
        });

        // --- L√ìGICA PARA AGENDAMENTO DE NOTIFICA√á√ïES LOCAIS ---
        const btnAgendarLembreteLocal = document.getElementById('btnAgendarLembreteLocal');
        const modalAgendarLembrete = document.getElementById('modalAgendarLembrete');
        const modalCloseBtn = document.querySelector('.modal-close-btn');
        const selectTempoLembrete = document.getElementById('tempoLembrete');
        const customTimeInput = document.getElementById('customTimeInput');
        const inputDiasCustom = document.getElementById('diasCustom');
        const btnConfirmarAgendamento = document.getElementById('btnConfirmarAgendamento');
        const btnCancelarLembreteLocal = document.getElementById('btnCancelarLembreteLocal');
        const lembreteAgendadoStatus = document.getElementById('lembreteAgendadoStatus');

        // Abre o modal
        if (btnAgendarLembreteLocal) {
            btnAgendarLembreteLocal.addEventListener('click', () => {
                // Primeiro, verifica a permiss√£o de notifica√ß√µes
                if (Notification.permission === 'denied') {
                    alert('As notifica√ß√µes est√£o bloqueadas. Por favor, ative-as nas configura√ß√µes do seu navegador para usar este recurso.');
                    return;
                }
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            modalAgendarLembrete.style.display = 'flex';
                        } else {
                            alert('Permiss√£o de notifica√ß√µes negada. N√£o √© poss√≠vel agendar lembretes.');
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    modalAgendarLembrete.style.display = 'flex';
                }
            });
        }

        // Fecha o modal
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', () => {
                modalAgendarLembrete.style.display = 'none';
            });
        }

        // Fecha o modal se clicar fora do conte√∫do
        if (modalAgendarLembrete) {
            modalAgendarLembrete.addEventListener('click', (event) => {
                if (event.target === modalAgendarLembrete) {
                    modalAgendarLembrete.style.display = 'none';
                }
            });
        }

        // Mostra/esconde input de tempo customizado
        if (selectTempoLembrete) {
            selectTempoLembrete.addEventListener('change', () => {
                if (selectTempoLembrete.value === 'custom') {
                    customTimeInput.style.display = 'block';
                } else {
                    customTimeInput.style.display = 'none';
                }
            });
        }

        // Agendar lembrete
        if (btnConfirmarAgendamento) {
            btnConfirmarAgendamento.addEventListener('click', async () => {
                const tempoSelecionado = selectTempoLembrete.value;
                let diasParaLembrar = 0;

                if (tempoSelecionado === 'custom') {
                    diasParaLembrar = parseInt(inputDiasCustom.value, 10);
                    if (isNaN(diasParaLembrar) || diasParaLembrar <= 0) {
                        alert('Por favor, insira um n√∫mero v√°lido de dias.');
                        return;
                    }
                } else {
                    diasParaLembrar = parseInt(tempoSelecionado, 10);
                }

                if (serviceWorkerRegistration) {
                    const delayInSeconds = diasParaLembrar * 24 * 60 * 60; // Converter dias para segundos
                    const notificationTitle = "Precisa de √Ågua? üíß (H2O)";
                    const notificationBody = `N√£o deixe a sua √°gua acabar! Pe√ßa agora no H2O. O lembrete de ${diasParaLembrar} dias est√° agendado.`;
                    const notificationTag = 'water-reminder-local'; // Tag para identificar essa notifica√ß√£o
                    const notificationUrl = 'https://h2opediraguafacil.netlify.app/'; // URL para abrir ao clicar

                    // Envia a mensagem para o Service Worker
                    serviceWorkerRegistration.active.postMessage({
                        type: 'SCHEDULE_REMINDER',
                        delayInSeconds: delayInSeconds,
                        title: notificationTitle,
                        body: notificationBody,
                        tag: notificationTag,
                        url: notificationUrl
                    });

                    modalAgendarLembrete.style.display = 'none';
                    updateScheduledReminderStatus(true, diasParaLembrar); // Atualiza status na UI
                    alert(`Lembrete agendado para daqui a ${diasParaLembrar} dias!`);
                } else {
                    alert('Service Worker n√£o est√° dispon√≠vel para agendar o lembrete.');
                    console.error('Service Worker n√£o registrado ou n√£o ativo.');
                }
            });
        }

        // Cancelar lembrete
        if (btnCancelarLembreteLocal) {
            btnCancelarLembreteLocal.addEventListener('click', async () => {
                if (confirm('Tem certeza que deseja cancelar todos os lembretes de √°gua agendados?')) {
                    if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                        serviceWorkerRegistration.active.postMessage({ type: 'CANCEL_ALL_REMINDERS' });
                        updateScheduledReminderStatus(false);
                        alert('Todos os lembretes agendados foram cancelados.');
                    } else {
                        alert('Service Worker n√£o est√° dispon√≠vel.');
                    }
                }
            });
        }

        // Fun√ß√£o para verificar se h√° lembretes agendados e atualizar o status na UI
        async function checkScheduledReminderStatus() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                // Precisamos de uma forma de o cliente (index.html) consultar o Service Worker
                // sobre notifica√ß√µes agendadas. Uma forma simples √© usar localStorage
                // ou uma mensagem de ida e volta para o SW, mas para simplificar
                // e dado que o SW j√° gerencia o IndexedDB, vamos simular um status
                // que o SW pode setar ou que se assume at√© que seja desativado.

                // Por enquanto, vamos usar o localStorage para o status da UI aqui.
                const hasReminder = localStorage.getItem('h2o-reminder-active');
                const reminderDays = localStorage.getItem('h2o-reminder-days');
                if (hasReminder === 'true' && reminderDays) {
                    updateScheduledReminderStatus(true, parseInt(reminderDays, 10));
                } else {
                    updateScheduledReminderStatus(false);
                }
            } else {
                // SW n√£o est√° ativo ou n√£o suportado
                if (btnAgendarLembreteLocal) {
                    btnAgendarLembreteLocal.textContent = 'Lembretes Locais Indispon√≠veis';
                    btnAgendarLembreteLocal.disabled = true;
                    btnAgendarLembreteLocal.classList.add('desativado');
                }
                lembreteAgendadoStatus.textContent = 'Lembretes locais n√£o suportados ou SW n√£o ativo.';
                lembreteAgendadoStatus.style.display = 'block';
            }
        }

        function updateScheduledReminderStatus(active, days = null) {
            if (active) {
                lembreteAgendadoStatus.textContent = `Lembrete de √°gua agendado para daqui a ${days} dias.`;
                lembreteAgendadoStatus.style.display = 'block';
                if (btnAgendarLembreteLocal) {
                    btnAgendarLembreteLocal.textContent = 'Lembrete Agendado (Clique para gerenciar)';
                    btnAgendarLembreteLocal.classList.add('ativado');
                    btnAgendarLembreteLocal.classList.remove('desativado');
                }
                localStorage.setItem('h2o-reminder-active', 'true');
                localStorage.setItem('h2o-reminder-days', days);
            } else {
                lembreteAgendadoStatus.textContent = 'Nenhum lembrete de √°gua agendado.';
                lembreteAgendadoStatus.style.display = 'block';
                if (btnAgendarLembreteLocal) {
                    btnAgendarLembreteLocal.textContent = '‚è∞ Agendar Lembrete de √Ågua';
                    btnAgendarLembreteLocal.classList.remove('ativado');
                    btnAgendarLembreteLocal.classList.remove('desativado'); // remove desativado se estava
                    btnAgendarLembreteLocal.disabled = false; // reabilita o bot√£o
                }
                localStorage.removeItem('h2o-reminder-active');
                localStorage.removeItem('h2o-reminder-days');
            }
        }

        // Executa fun√ß√µes de inicializa√ß√£o
        window.addEventListener('load', () => {
            exibirSaudacaoDinamica();
            mostrarDicaParaIOS();
            // initialiseNotificationUI() √© agora chamado dentro do .then() do registro do SW
            // checkScheduledReminderStatus() √© agora chamado dentro do .then() do registro do SW
        });
    </script>
</body>
</html>